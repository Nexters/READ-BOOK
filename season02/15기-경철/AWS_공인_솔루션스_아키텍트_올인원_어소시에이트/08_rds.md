- [Amazon RDS](#amazon-rds)
  - [RDS 고가용성](#rds-고가용성)
  - [RDS 확장성](#rds-확장성)
    - [RDS 인스턴스 타입 변경 `스케일 업 / 스케일 다운`](#rds-인스턴스-타입-변경-스케일-업--스케일-다운)
    - [Reader Replica](#reader-replica)
  - [RDS 보안](#rds-보안)
    - [암호화](#암호화)
    - [암호화 주의사항](#암호화-주의사항)
  - [백업, 복구, 스냅샷](#백업-복구-스냅샷)
  - [모니터링](#모니터링)
    - [퍼포먼스 인사이트](#퍼포먼스-인사이트)
- [Amazon Aurora](#amazon-aurora)
  - [Amazon Aurora 스토리지 및 안전성](#amazon-aurora-스토리지-및-안전성)
    - [Amazon Aurora 클러스터 볼륨과 스토리지](#amazon-aurora-클러스터-볼륨과-스토리지)
    - [Amazon Aurora의 안정성](#amazon-aurora의-안정성)
  - [Amazon Aurora의 고가용성](#amazon-aurora의-고가용성)
    - [DB 인스턴스 컴퓨팅 고가용성](#db-인스턴스-컴퓨팅-고가용성)
    - [데이터 고가용성](#데이터-고가용성)
    - [AWS 리전 간 고가용성](#aws-리전-간-고가용성)

# Amazon RDS

Amazon RDS docs: [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/Welcome.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/Welcome.html)

AWS는 관계형 데이터베이스 호스팅 및 관리 서비스인 Amazon RDS `Amazon Relational Database Service`를 제공한다. Amazon RDS에서 사용할 수 있는 RDBMS는 다음과 같다.

- Aurora MySQL
- Aurora Postgresql
- Oracle
- SQL Server
- MySQL
- Postgresql
- MariaDB

Amazon RDS는 완전 관리형 서비스이므로 데이터베이스를 구성하기 위한 인프라 설정은 AWS에서 알아서 해준다. 또한 사용한 만큼 및 프로비저닝한만큼의 비용, I/O 요청 횟수, 백업 스토리지, 데이터 유입 유출 전송량 등의 사용량을 기준으로 비용을 지불한다.

다만, 이용에 제약이 따르는 부분도 존재한다. RDS에서 지원하는 MySQL, MariaDB, PostgreSQL, Oracle, 및 Microsoft SQL Server는 EBS를 사용하는데 범용 SSD를 사용이나 프로비저닝된 IOPS 스토리지를 사용하느냐에 따라 용량이 달라진다. 보통 MariaDB, MySQL, Oracle 및 PostgreSQL 인스턴스는 64TB까지 사용가능하다. 용량 이외에도 사용자가 RDS를 호스팅하는 운영체제에 접근할 수 없으며 운영체제 관련 수정을 할 수 없다.

## RDS 고가용성

Amazon RDS는 다중 AZ 배포를 통해 고가용성과 장애 조치 기능을 지원한다.

> 단, SQL Server 인스턴스의 경우 데이터베이스 미러링 또는 상시 가동 가용성 그룹을 사용한다.

[SQL Server의 다중 AZ 배포 참고](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/USER_SQLServerMultiAZ.html)

RDS는 자동으로 서로 다른 가용 영역에 동기식 예비 복제본을 프로비저닝하고 유지한다. 기본 데이터베이스 `primary, master`는 가용 영역에서 예비 복제본으로 동기식으로 복제되어 데이터 이중화를 제공하고 I/O 중지를 제거하며 시스템 백업 시 지연 시간 스파이크를 최소화한다.

스텐바이 데이터 베이스는 애플리케이션이 실행되고 있는 기본 데이터베이스가 셧다운되는 상황을 대비하여 가동 기능 상태에서 대기한다. 만약 기본 데이터베이스가 장애 상태가 된다면 대기 상태의 데이터베이스를 가동한다.

고가용성을 위해 RDS 인스턴스를 생성하기 위해서는 다중 AZ를 지정하여 생성할 수 있다. 이미 생성된 RDS 인스턴스도 다중 AZ 옵션을 활성화하여 변경할 수 있다.

> 다중 AZ를 사용할수도 있지만 다중 AZ 설정이 필요없다면 `ex. 개발환경` 싱글 AZ 배포를 통해, 즉, 다중 AZ 옵션을 선택하지 않고 생성할 수 있다.

당연히 단일 AZ 배포 RDS에 비해 다중 AZ 배포 RDS의 비용이 더 크다.
[RDS 비용 참고](https://aws.amazon.com/ko/rds/mysql/pricing/)

## RDS 확장성

RDS는 사용자가 늘어나고 줄어듬에 따라 인스턴스의 타입을 늘리고 줄이는 스케일 업, 스케일 다운을 지원하고 마스터 슬레이브 방식으로 Reader Replica를 두어 read-only 쿼리의 경우 Reader로 분산하여 마스터 데이터베이스 인스턴스의 부하를 줄여줄 수 있다.

### RDS 인스턴스 타입 변경 `스케일 업 / 스케일 다운`

RDS의 인스턴스 타입 변경은 AWS 콘솔에서 손쉽게 가능하다. 다만, 타입 변경시 약간의 순단이 발생할 수 있으므로 이에 대한 확인 및 조치가 필요하다.

만약 여러개의 Reader Replica를 가지고 있는 형태라면 Reader의 인스턴스 타입을 먼저 변경한 후에 Writer `Master` 인스턴스를 페일오버한 후 Reader를 Writer로 승격하는 방법을 사용할수도 있다.

### Reader Replica

Reader는 Master `Writer`의 read-only 복사본으로 Master 데이터베이스와 동기화 상태를 유지하고 읽기 전용 쿼리를 처리하여 Master 데이터베이스의 부하를 줄여줄 수 있다. 글로벌 서비스 시에는 Reader만 따로 해당 지역에 두어 read-only 트래픽을 처리할 수 있다.

또한 Master 데이터베이스가 장애로 다운이 되는 경우 자동으로 Reader Replica를 Master로 승격하도록 RDS가 지원한다.

RDS에서 Reader Replica는 최대 15개까지 지닐 수 있다.

## RDS 보안

Amazon RDS는 기본적으로 Amazon VPC 내에서 다룰 수 있다. VPC를 퍼블릭으로 두어 외부에서도 접근 가능하도록 설정할수도 있지만 일반적으로는 데이터베이스의 보안을 위해 프라이빗 서브넷을 구성하여 설정하는 것이 좋다.

VPC를 활용하여 유저와 애플리케이션의 접근을 효율적으로 관리할 수 있으며 필요시 보안 그룹 `Security Group`을 두어 트래픽 흐름을 조절할 수 있다.

### 암호화

Amazon RDS는 데이터베이스 암호화 기능을 제공한다. RDS 의 암호화된 인스턴스는 데이터 보안을 위한 추가적인 레이어를 제공해 비인가 접근을 차단한다. Amazon RDS 암호화는 클라우드에 배포된 애플리케이션의 데이터 보안 수준을 높이며, 저장 상태 데이터의 암호화 법규에 대한 준수 의무를 효과적으로 지킬 수 있다.

Amazon RDS는 기본적으로 AES-256 암호화 알고리즘이 사용되며 암호화 기능을 사용하면 AWS KMS 내에 RDS를 위한 키가 생성되어 RDS 인스턴스의 데이터 암호화 및 복호화에 사용할 수 있다.

Amazon RDS의 데이터베이스 암호화에는 다음 항목에 대한 암호화가 포함된다.

- 데이터베이스 인스턴스 스토리지 암호화
- 자동화된 백업 암호화
- 마스터 데이터베이스의 읽기 사본 암호화
- 마스터 데이터베이스의 스탠바이 데이터베이스 암호화
- 데이터베이스로 생성한 스냅삿 암호화

> 참고로 Oracle과 SQL Server의 경우 데이터베이스 엔진에서 기본으로 제공하는 암호화 방식인 Transparent Database Encyption `TDE`를 사용하더라도 Amazon RDS의 암호화 기능을 사용할수는 있지만 RDS가 제공하는 암호화나 TDE 중 하나를 선택해야한다. 그렇지 않으면 성능 저하가 나타날 수 있다.

### 암호화 주의사항

- Amazon RDS DB 인스턴스에 대한 암호화는 암호화를 생성할 때에만 활성화할 수 있으며 DB 인스턴스가 생성된 후에는 불가능하다.

다만 암호화되지 않은 스냅샷의 사본을 암호화할 수 있기 때문에 암호화되지 않은 DB 인스턴스에 실질적으로 암호화를 추가할 수는 있다. 즉, DB 인스턴스의 스냅샷을 만든 다음 해당 스냅샷의 암호화된 사본을 만들 수 있다. 그런 다음 암호화된 스냅샷에서 DB 인스턴스를 복구할 수 있고, 원본 DB 인스턴스의 암호화된 사본이 생긴다.
- 암호화된 DB 인스턴스의 암호화를 비활성화할 수 없다.
- 암호화되지 않은 DB 인스턴스의 암호화된 스냅샷은 생성할 수 없다.
- 암호화된 DB 인스턴스의 스냅샷은 DB 인스턴스와 동일한 CMK를 사용하여 암호화해야 한다.
- 암호화되지 않은 DB 인스턴스의 암호화된 읽기 전용 복제본이나 암호화된 DB 인스턴스의 암호화되지 않은 읽기 전용 복제본은 보유할 수 없다.
- 암호화된 읽기 전용 복제본이 원본 DB 인스턴스와 동일한 AWS 리전에 있는 경우 해당 인스턴스와 동일한 CMK를 사용하여 암호화해야 한다.
- 암호화된 백업 또는 스냅샷을 암호화된 DB 인스턴스로 복원할 수 없다.
- 암호화된 스냅샷을 한 AWS 리전에서 다른 리전으로 복사하려면 대상 AWS 리전에 CMK를 지정해야 한다. 이는 CMK가 생성된 AWS 리전에만 해당하기 때문이다.
- 암호화된 DB 인스턴스의 암호화를 해제할 수 없다. 하지만 암호화된 DB 인스턴스에서 데이터를 내보내고 암호화되지 않은 DB 인스턴스로 해당 데이터를 가져올 수 있다.

## 백업, 복구, 스냅샷

- 백업

    Amazon RDS 엔진은 하루 한 번의 백업을 실행한다. 

    사용자는 필요에 따라 백업 윈도우의 일정을 조절할 수 있고, 백업이 완벽하게 잘 끝났는지 확인하기 위해 백업 과정을 모니터링할 수 있다. 백업 항목에는 전 체 데이터베이스, 전송 로그, 변경 로드 등이 포함된다. 백업 보존 기간은 35일이며, 서포트 티켓을 이용해 백업 보존 기간을 늘릴 수 있다. 사용자가 인스턴스를 배포한 AZ 마다 다수의 백업 복사본이 유지된다.

    Aurora의 경우 S3 버킷에 자동으로, 지속적으로 백업이 저장되므로 사용자는 별도의 백업 작업을 할 필요가 없지만, 필요시 언제든 수동으로 백업을 생성할 수 있다. Aurora도 마찬가지로 35일 간 백업 보존 기간을 가지며 서포트 티켓으로 기간을 늘릴 수 있다.

- 복구

    백업에서 데이터베이스를 복구하는 경우 기존 데이터베이스와 동일한 복사본을 사용하거나 기존에 존재하는 데이터베이스에 복제를 할 수 있다.

- 스냅샷

    백업의 또 다른 방법으로 스냅샷 기능이 있다. 참고로 스냅샷은 자동으로 관리할 수 없기 때문에 수동으로 직접 생성해야한다.

    스냅샷 생성시에는 임시 I/O 처리를 제공하기 때문에 I/O 처리량이 많은 때에 스냅샷 생성은 자제해야한다.

    스냅샷은 S3에 생성되며 사용자는 이를 통해 데이터베이스를 복원할 수 있다.

## 모니터링

Amazon RDS는 모든 성능 지표를 Amazon CloudWatch를 통해 전송하고 이를 AWS 콘솔에서 확인할 수 있다.

기본적으로는 표준 모니터링 기능으로 15~18개의 지표를 모니터링할 수 있다. CPU 사용량, 메모리, 스왑 사용량, I/O, 쿼리 지연 등의 지표를 모니터링할 수 있다. 사용자는 1분 간격으로 지표를 갱신하여 볼 수 있다.

표준 모니터링 기능에서 더 세분화된 지표를 보고 싶을 수 있다. 이를 위해서 강화된 모니터링 `Enhanced Monitoring`을 지원한다. 표준 모니터링의 지표를 포함해 총 50개의 지표를 볼 수 있다. 1초 주기로 성능 지표를 갱신하며 RDS를 지원하는 모든 RDBMS 엔진에서 사용할 수 있다.

Amazon RDS 주요 모니터링 정보: [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/accessing-monitoring.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/accessing-monitoring.html)

> 모니터링 관련하여 Amazon RDS 권장사항을 AWS 콘솔에서 확인할 수 있다. 또한 권장 사항을 즉시 조치하도록 설정할 수 있다.

### 퍼포먼스 인사이트

Amazon RDS의 모니터링 기능을 확장하여 데이터베이스의 성능을 시각화해 성능에 영향을 끼치는 요소를 분석하는데 도움을 주는 기능이다.

퍼포먼스 인사이트 대시보드에서 데이터베이스의 워크로드를 시각화하고 대기상태, SQL 명령, 호스트, 유저 등의 워크로드를 필터링 할 수 있도록 기능을 제공한다.

퍼포먼스 인스턴스의 성능 데이터는 35일간 보존된다.

> Aurora Postgresql 엔진에서는 기본적으로 퍼포먼스 인사이트 기능을 제공한다.

# Amazon Aurora


Amazon Aurora docs: [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/CHAP_AuroraOverview.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/CHAP_AuroraOverview.html)

Amazon Aurora는 클라우드에 최적화된 MySQL 및 PostgreSQL 호환 관계형 데이터베이스이다. 완전 분산형 및 자가 진단형 스토리지 시스템을 통해 성능 및 신뢰성을 보장하며 고가용성을 제공한다. 기본적으로 클러스터링과 복제를 자동화하고 표준화한다.

> MySQL의 최대 5배, PostgreSQL의 최대 3배의 처리량 성능을 제공한다.

앞서 언급했듯이 MySQL과 PostgreSQL 데이터베이스 엔진을 지원한다. MySQL의 경우 InnoDB를 사용하는 5.6과 5.7 버전과 호환되는 반면 PostgreSQL은 9.7, 10.12, 11.7 버전과 호환된다.

Amazon Aurora DB 클러스터는 하나 이상의 DB 인스턴스와 이 DB 인스턴스의 데이터를 관리하는 클러스터 볼륨으로 구성된다. Aurora 클러스터 볼륨은 다중 AZ를 아우르는 가상 데이터베이스 스토리지 볼륨으로 각 가용영역에 DB 클러스터 데이터의 사본이 있다.

![](https://user-images.githubusercontent.com/30178507/126869684-40ddfc11-f346-44f7-a3bf-e3e736fbf473.png)

위 그림은 Aurora DB 클러스터에 속하는 Primary 인스턴스와 Replica 인스턴스 사이의 관계를 보여준다. 여러 AZ를 아우르는 스토리지 볼륨 위에 각 AZ에 Primary와 Replica 인스턴스가 동작하는 구조이다.

서로 다른 AZ에 있는 여섯 개의 서로 다른 스토리지 노드로 분리된 스토리지 레이어에 자동으로 데이터를 복제히는데 이는 별도의 비용없이 데이터를 여섯번 미러링 한다는 측면에서 의미가 크다. 이와 같은 모든 데이터 미러링은 동기적으로 진행되므로 데이터 손실이 발생하지 않는다. 또 Amazon Aurora는 멀티 스토리지 노드에서의 데이터 가용성을 보장하기 위해 읽기 및 쓰기를 위한 쿼럼 시스템을 사용한다. 동시에, 모든 데이터는 S3에 지속적으로 백업돼 신뢰성 및 가용성을 제공한다.

Aurora 클러스터의 스토리지는 최대 128TB까지 지원하며 필요에 따라 자동으로 커진다. Amazon RDS와 마찬가지로 Replica는 최대 15대까지 지원한다.

## Amazon Aurora 스토리지 및 안전성

### Amazon Aurora 클러스터 볼륨과 스토리지

Amazon Aurora는 Aurora SSD를 사용하는 단일 가상 볼륨인 클러스터 볼륨에 저장된다. 클러스터 볼륨은 동일한 AWS 리전에 속한 세 가용 영역의 데이터 사본으로 구성된다. 이렇게 가용 영역에서 자동으로 복제가 되기 때문에 데이터 손실 가능성을 줄이고 내구성을 높여준다. 특히 장애 조치 중에도 데이터 사본이 이미 다른 AZ에 존재하기 때문에 DB 인스턴스에 대한 요청을 계속해서 처리할 수 있다.

클러스터 볼륨에는 사용자 데이터, 스키마 객체, 메타 데이터 `시스템 테이블, 바이너리 로그 등`가 포함되어있다.

Aurora 스토리지는 데이터 용량이 늘어날수록 Aurora 클러스터 볼륨도 자동으로 확장된다. Aurora 클러스터 볼륨의 최대 크기는 128TB까지 증가할 수 있고 자동 조정은 스토리지 하위 시스템에 의해 이뤄진다.

### Amazon Aurora의 안정성

Aurora는 안정성, 내구성, 내결함성을 고려하여 설계되었다. Aurora DB 클러스터는 Aurora 복제본을 추가해서 다른 AZ에 배포하는 등의 방법으로 가용성을 높이도록 설계가능하다.

- 스토리지 자동 복구

    Amazon Aurora는 3개의 가용 영역에 여러 개의 복사본을 보관하고 있기 때문에 디스크 결함으로 인한 데이터 손실 가능성을 최소화한다. 만약 디스크 볼륨 세그먼트에 결함이 감지되면 자동으로 해당 디스크 볼륨 세그먼트를 복구한다.

- 유지 가능한 캐시 워밍

    Aurora는 전원이 꺼진 데이터베이스를 가동하거나 결함 발생 이후 다시 시작할 때 버퍼 풀 캐시를 워밍한다. 다시 말하면 인메모리 페이지 캐시에 저장된 기존 공통 쿼리 페이지를 이용하여 버퍼 풀을 미리 로드한다.

    참고로 Aurora 페이지 캐시는 데이터베이스가 아닌 별도의 프로세스로 관리되므로 데이터베이스와는 상관없이 유지된다. 이 때문에 데이터베이스에 결함이 생기더라도 메모리에는 페이지 캐시가 남아있다.

- 충돌 복구

    Aurora은 거의 순간적으로 충돌에서 복구하고 바이너리 로그없이 애플리케이션 데이터를 계속 제공하도록 설계되어있다. Aurora은 병렬 스레드에서 비동기 방식으로 충돌 복구를 실행하므로 충돌 직후에도 데이터베이스를 열어두고 사용할 수 있다.

    Aurora는 DB 클러스터 내에서 데이터를 복제하거나 특정 시정 복원 `PITR`을 수행하기 위해 바이너리 로그를 필요로하지 않는다. 따라서 Aurora MySQL 엔진을 사용할 때는 외부 복제가 필요하지 않는다면 `binlog_format`을 `OFF`로 설정해서 바이너리 로깅을 비활성화하는 것이 좋다.

## Amazon Aurora의 고가용성

Aurora는 컴퓨팅 `DB 인스턴스`과 데이터 `스토리지`를 분리하여 DB 인스턴스를 이용할 수 없는 경우에도 데이터를 안전하게 유지할 수 있다.

### DB 인스턴스 컴퓨팅 고가용성

Aurora DB 클러스터는 최대 15개의 Replica를 가질 수 있다. Replica는 Reader 인스턴스로 사용되며 이를 통해 Writer `Master, Primary` 인스턴스의 부하를 줄여줄 수 있다.

만약 기본 인스턴스가 문제에 장애가 발생하여 다운되는 경우 Replica 중에 하나가 기본 인스턴스의 역할을 수행한다. 이를 **failover**라고 한다. 이를 통해 Aurora는 내결함성도 갖춘다.

### 데이터 고가용성

기본 DB 인스턴스에 데이터가 기록되면 Aurora에서 가용 영역의 데이터를 클러스터 볼륨과 연결된 6개의 스토리지 노드에 동기적으로 복제한다. 이를 통해 데이터 중복을 제공하고, I/O 중지를 없애고, 시스템 백업 중에 지연 시간 스파이크를 최소화한다. DB 인스턴스를 고가용성으로 실행하면 계획된 시스템 유지 관리 중 가용성을 향상시킬 수 있으며, 데이터베이스에서 오류 및 가용 영역 중단이 일어나는 것을 방지하는 효과가 있다.

### AWS 리전 간 고가용성

여러 AWS 리전 간의 고가용성을 위해 Aurora 글로벌 데이터베이스를 설정할 수 있다. 각 Aurora 글로벌 데이터베이스는 여러 AWS 리전에 걸쳐 있으므로 지연 시간이 짧은 글로벌 읽기 및 AWS 리전 간의 중단으로부터 재해 복구를 활성화한다. Aurora는 기본 AWS 리전에서 각 보조 리전으로 모든 데이터 및 업데이트 복제를 자동으로 처리한다.